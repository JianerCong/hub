% \documentclass[dvipsnames]{article}
\documentclass[dvipsnames]{ctexart}

\title{FollowMe å…±è¯†}
\usepackage{geometry}\geometry{
  a4paper,
  total={170mm,257mm},
  left=20mm,
  top=20mm,
}


\usepackage{svg}

\usepackage[skip=5pt plus1pt, indent=0pt]{parskip}
% Color
\newcommand{\mycola}{MidnightBlue}
\newcommand{\mycolb}{Mahogany}
\newcommand{\mycolc}{OliveGreen}

\newcommand{\cola}[1]{\textcolor{\mycola}{#1}}
\newcommand{\colb}[1]{\textcolor{\mycolb}{#1}}
\newcommand{\colc}[1]{\textcolor{\mycolc}{#1}}
\newcommand{\Cola}[1]{\textcolor{\mycola}{\textbf{#1}}}

% \let\emph\relax % there's no \RedeclareTextFontCommand
% \DeclareTextFontCommand{\emph}{\bfseries}
\renewcommand{\emph}[1]{\texbf{#1}}

\usepackage{fontspec}

\setmonofont{Cascadia}[
Path=/usr/share/fonts/truetype/Cascadia_Code/,
Scale=0.85,
Extension = .ttf,
UprightFont=*Code,              %find CascadiaCode.ttf
BoldFont=*CodePL,               %find CascadiaCodePL.ttf ...
ItalicFont=*CodeItalic,
BoldItalicFont=*CodePLItalic
]
% --------------------------------------------------
% Windows
% \setmonofont{Cascadia}[
% Path=C:/Windows/Fonts/,
% Extension = .ttf,
% UprightFont=*Mono,              %find CascadiaMono.ttf
% BoldFont=*Code,               %find CascadiaCodePL.ttf ...
% ItalicFont=*Code,
% BoldItalicFont=*Code
% ]


\usepackage{minted}
\usepackage{tcolorbox}
\tcbuselibrary{skins}
\tcbuselibrary{minted}
\usepackage{tikz}
\usetikzlibrary{shapes} % ellipse node shape
\usetikzlibrary{shapes.multipart} % for line breaks in node text
\usetikzlibrary{arrows.meta}    %-o arrow head
\usetikzlibrary{arrows}
\usetikzlibrary{matrix}


\usepackage{amsmath}
% ??? still xelatex?
% \usepackage{xeCJK}
\usepackage{emoji}
% \setemojifont{NotoColorEmoji.ttf}[Path=C:/Users/congj/repo/myFonts/]
% \setemojifont{TwitterColorEmoji-SVGinOT.ttf}[Path=C:/Users/congj/repo/myFonts/]


\newtcolorbox[auto counter]{myBox}[2][]{
  fonttitle=\bfseries,title={å…±è¯†~\thetcbcounter: #2},#1
}
\newtcolorbox[]{noteBox}[1][]{
  tile,left=1mm,nobeforeafter,fontupper=\small,#1
}

\tikzstyle{myNode}=[inner sep=2pt,circle,text=white]
\date{\today}
\author{ä½œè€…}

\newtcblisting{simplec}{
  listing engine=minted,
  minted language=c++,
  minted style=vs,
  minted options={fontsize=\small,autogobble,
    % framesep=1cm
  },
  tile,
  listing only,
  % bottom=0cm,
  % nobeforeafter, 
  boxsep=0mm,
  left=1mm,
  opacityback=0.5,
  colback=gray!20
}
\tcbuselibrary{breakable}
\newtcblisting{simplepy}{
  listing engine=minted,
  minted language=python,
  minted style=vs,
  minted options={fontsize=\small,autogobble,
    % framesep=1cm
  },
  tile,
  listing only,
  % bottom=0cm,
  % nobeforeafter,
  boxsep=0mm,
  left=1mm,
  opacityback=0.5,
  colback=gray!20,
  breakable
}
\newtcolorbox{blackbox}{tile,colback=black,colupper=white,nobeforeafter,halign=flush center}

\tikzstyle{myMatrix}=[matrix of nodes,below right,
nodes={above,text centered},                  %apply to all nodes
row sep=1cm,column sep=2cm]
\tikzstyle{every node}=[inner sep=0pt]

\newcommand\uptoleft[3][-o]{\draw[very thick,#1](#2.south) |- (#3.west);}
\newcommand\uptodown[3][-o]{\draw[very thick,#1](#2.south) to [out=270,in=90] (#3.north);}
\newcommand\downtoup[3][-latex]{\draw[very thick,#1](#2.north) to [out=90,in=270] (#3.south);}

\newcommand\lefttoright[3][-latex]{\draw[very thick,#1](#2.east) to[out=0,in=180] (#3.west);}
\newcommand\lefttodown[3][-latex]{\draw[very thick,#1](#2.east) to[out=0,in=90] (#3.north);}


\newtcolorbox{leftDialogBox}{
  tile, nobeforeafter, boxsep=0pt,
  % show bounding box,
  colback=\mycola!10,
  overlay={
    \begin{scope}
      % \fill[gray!10] (frame.east) circle (2pt);
      \fill[\mycola!10] (frame.east) --
      +(0,2mm) --
      +(3mm,0) --
      +(0,-2mm)
      ;
    \end{scope}
  }}


\newtcolorbox{rightDialogBox}{
  tile, nobeforeafter, boxsep=0pt,
  % show bounding box,
  colback=\mycola!10,
  overlay={
    \begin{scope}
      % \fill[gray!10] (frame.east) circle (2pt);
      \fill[\mycola!10] (frame.west) --
      +(0,2mm) --
      +(-3mm,0) --
      +(0,-2mm);
    \end{scope}
  }}

\newcommand{\mycolaa}{\mycola!20}


% --------------------------------------------------
\begin{document}
\maketitle
\begin{comment}
\section{å¬ä¸€ä¸ªå…±è¯†}
è®©æˆ‘ä»¬æ¥æƒ³ä¸€ä¸ªå…±è¯†ã€‚ä¼˜å…ˆè¦æ±‚è¿™å‡ ç‚¹ï¼š
\begin{itemize}
\item å•èŠ‚ç‚¹å¯è·‘
\item å¯ï¼ˆç›¸å¯¹æ–¹ä¾¿åœ°ï¼‰åŠ¨æ€æ–°å¢èŠ‚ç‚¹
\end{itemize}
\emoji{parrot} : é‚£ä¹ˆæœ€ç®€å•çš„åº”è¯¥å°±æ˜¯
\begin{myBox}{å¬ä¸€ä¸ªå…±è¯† Listen-to-one Consensus}
  \label{cons-a}
  \begin{itemize}
  \item ç¬¬ä¸€ä¸ªèµ·çš„èŠ‚ç‚¹ä¸ºPrimaryã€‚
  \item æ–°å¢çš„èŠ‚ç‚¹å¾€Primaryä¸Šè¿æ¥ã€‚
  \end{itemize}
\end{myBox}

\emoji{parrot} : è¿™ä¸ªå…¶å®æœ¬è´¨ä¸Šå°±æ˜¯åœ¨é›†ç¾¤å†…éƒ¨çš„ä¸€ä¸ª Server-Client æ¶æ„å˜›ã€‚
ä¹Ÿå°±æ˜¯æ‰€æœ‰äººéƒ½åªå¬Primaryçš„ã€‚
\begin{center}
  \begin{tikzpicture}
    % \tikzstyle{every node}=[inner sep=2pt]
    \node[myNode,fill=\mycola,minimum height=4em] (a1) {primary};
    \foreach \d in {0,60,...,300}{
      \draw[latex-, very thick] (a1) -- (\d:3cm) node[myNode,fill=gray]{æ–°å¢èŠ‚ç‚¹};
      % \node[myNode,fill=gray]  at (\d:2cm) {};
    }
  \end{tikzpicture}
\end{center}
è¿™ä¸ªçš„ç¼ºç‚¹å°±æ˜¯\cola{ä¸»æœºdownäº†ï¼Œé›†ç¾¤å°±downäº†}ã€‚å®ƒçš„ä¼˜ç‚¹å°±æ˜¯æ–°å¢çš„èŠ‚ç‚¹åªéœ€è¦å’Œä¸»
èŠ‚ç‚¹è¿æ¥å°±è¡Œï¼Œè€Œä¸”éprimaryå½¼æ­¤ä¸éœ€è¦çŸ¥é“å½¼æ­¤ã€‚

\begin{tikzpicture}
  \emoji{parrot} é‚£ä¹ˆä»£ç è¯¥æ€ä¹ˆå†™å‘¢ï¼Ÿ\\
  \emoji{turtle} åœ¨å†™ä»£ç ä¹‹å‰æˆ‘ä»¬å…ˆå®šä¹‰å…±è¯†æ‰€éœ€è¦çš„æ¥å£å§ã€‚
\end{tikzpicture}
\subsection{å…±è¯†éœ€è¦çš„æ¥å£}
æŠ½è±¡ä¸€ç‚¹è®²ï¼Œå…±è¯†æœ€å°‘éœ€è¦ä¸¤ç»„å¤–éƒ¨æ¥å£ã€‚
\begin{enumerate}
\item ç½‘ç»œï¼Œè¿™ä¸ªåŒ…æ‹¬
  \begin{itemize}
  \item æ¥å—å¤–éƒ¨çš„è¯·æ±‚ï¼ˆç›‘å¬ï¼‰
  \item P2Pæ²Ÿé€š ï¼ˆç›‘å¬ + å‘é€ï¼‰
  \end{itemize}
\item æ‰§è¡Œï¼ŒæŠŠä¸€ä¸ªå‘½ä»¤å†™åˆ°å†…éƒ¨å­˜å‚¨ã€‚
\end{enumerate}
ç½‘ç»œçš„æ¥å£å¤§æ¦‚å¯ä»¥å®šä¹‰ä¸ºï¼š
\begin{simplepy}
from collections.abc import Callable
class IEndpointBasedNetworkable:
    def listen(self,
               target: str,     # The target, e.g. "/"
               handler: Callable[[str,str],Optional[str]]
               # The handler, accepts
               #  - endpoint, e.g. "localhost:8080"
               #  - request data
               # returns the result
               ):
        pass
    def listened_endpoint() -> str:
        pass
    def send(self,endpoint: str, target: str, data: str) -> Optional[str]:
        # endpoint: the target, e.g. "localhost:8080"
        # target: e.g. "/hi"
        pass
\end{simplepy}
è€Œæ‰§è¡Œçš„æ¥å£ï¼Œå¤§æ¦‚æ˜¯è¿™æ ·çš„ï¼š
\begin{simplepy}
class IExecutable:
    def execute(self,command: str):
        pass
\end{simplepy}

\subsection{\textbf{å¬ä¸€ä¸ªå…±è¯†}ï¼Œä¼ªä»£ç å®ç°}
é‚£ä¹ˆç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ç äº†,å…ˆä»æ„å»ºå‡½æ•°å¼€å§‹ï¼Œé™¤äº†æ‰§è¡Œå’Œç½‘ç»œä»¥å¤–ï¼Œæ„å»ºå‡½æ•°è¿˜æ¥å—ä¸€
ä¸ªå¯é€‰çš„\texttt{nodeToConnect}ï¼Œå¦‚æœæ²¡ç»™ï¼Œåˆ™è¯´æ˜è¿™ä¸ªæ˜¯ç¬¬ä¸€ä¸ªèµ·çš„èŠ‚ç‚¹ï¼ˆprimaryï¼‰ã€‚
\begin{simplepy}
class ListenToOneConsensus:
    def __init__(self,
                 n: IEndpointBasedNetworkable,
                 e: IExecutable,
                 nodeToConnect=''):
        self.net = n
        self.exe = e
        if nodeToConnect:
            self.primary = nodeToConnect
            self.is_primary = false
            self.ask_primary_for_entry()
            self.start_listening_as_sub()
        else:
            self.is_primary = true
            self.start_listening_as_primary()
\end{simplepy}
\emoji{parrot} ï¼š é‚£ä¹ˆå…·ä½“primaryå’ŒéprimaryèŠ‚ç‚¹éƒ½è¦ç›‘å¬å“ªäº›äº‹ä»¶å‘¢ï¼Ÿ

åœ¨ä»‹ç»å…·ä½“è¦ç›‘å¬å“ªäº›äº‹ä»¶ä¹‹å‰ï¼Œæˆ‘ä»¬æœ€å¥½å…ˆçœ‹ä¸€ä¸‹åœ¨â€œæ—¶å…‰é™å¥½â€çš„æƒ…å†µä¸‹ï¼Œé›†ç¾¤æ˜¯æ€ä¹ˆ
å·¥ä½œçš„ï¼š
\begin{center}
  \begin{tikzpicture}
    \node[myNode,fill=\mycola,minimum height=4em] (a1) {primary};
    \foreach \d in {300,20}{
      \draw[latex-, very thick] (a1) -- (\d:3cm) node[myNode,fill=gray,name=s-\d]{æ–°å¢èŠ‚ç‚¹};
      % \node[myNode,fill=gray]  at (\d:2cm) {};
    }
    \node (a1n) [text width=7cm,above left] at ([shift={(-2cm,0cm)}]a1.west){
      \begin{tcolorbox}[tile,fontupper=\small,
        left=0mm,
        boxsep=0mm
        ]
        \begin{itemize}
        \item æ¯æ”¶åˆ°ä¸€ä¸ª\colc{è¯·æ±‚}ï¼š
          \begin{enumerate}
          \item å…ˆæ‰§è¡Œä¸€ä¸‹ï¼Œ
          \item ç„¶åæ·»åŠ åˆ°ä¸€ä¸ª\cola{ç¬”è®°æœ¬}é‡Œï¼Œ
          \item ç„¶åå‘ç»™æ‰€æœ‰\colb{å·²çŸ¥ä¸‹çº§}ã€‚
          \end{enumerate}
        \item æ¯å½“æœ‰\colb{æ–°èŠ‚ç‚¹}è¦æ±‚åŠ å…¥æ—¶ï¼š
          \begin{enumerate}
          \item å…ˆæŠŠ\colb{å®ƒ}åŠ å…¥\colb{å·²çŸ¥ä¸‹çº§}ï¼Œ
          \item ç„¶åæŠŠ\cola{ç¬”è®°æœ¬}å‘ç»™\colc{å®ƒ}ä¸€ä»½ã€‚
          \end{enumerate}
        \end{itemize}
      \end{tcolorbox}
    };
    \draw[help lines,-o] (a1n) -- (a1);

    \node (s2n) [text width=7cm,above] at ([shift={(0cm,2cm)}] s-20.north){
      \begin{tcolorbox}[tile,fontupper=\small,
        left=0.5mm,
        boxsep=0mm]
        åœ¨åˆšå¼€å§‹çš„æ—¶å€™è¯·æ±‚\cola{primary}åŠ å…¥ã€‚
        \begin{itemize}
        \item æ¯æ”¶åˆ°æ¥è‡ª\cola{primary}çš„\colc{è¯·æ±‚}ï¼š æ‰§è¡Œ
        \item æ¯æ”¶åˆ°æ¥è‡ª\colb{client}çš„\colc{è¯·æ±‚}ï¼š ä¼ ç»™\cola{primary}
        \end{itemize}
      \end{tcolorbox}
    };

    \draw[help lines,o-] (s-20) -- (s2n);
  \end{tikzpicture}
\end{center}
Emm,é‚£ä¹ˆçœ‹æ¥ï¼Œprimaryå’Œéä¸»èŠ‚ç‚¹æ‰€è¦ç›‘å¬çš„ï¼ˆå’Œå‘é€çš„)ä¹Ÿå°±å¾ˆæ˜æ˜¾äº†ã€‚é¦–å…ˆæˆ‘ä»¬æ¥çœ‹
primaryéœ€è¦ç”¨åˆ°çš„æ–¹æ³•ã€‚
\begin{simplepy}
    def start_listening_as_primary(self):
        self.known_subs = []
        self.command_history = []
        self.net.listen('/pleaseAddMe',
                        self.handle_add_new_node)
        self.net.listen('/pleaseExecuteThis',
                        self.handle_execute_for_primary)

    def handle_add_new_node(self,sub_endpoint: str,
                            data: str) -> str:
        """[For primary] to add new node"""
        self.known_subs.append(sub_endpoint)
        return f"""
        Dear {sub_endpoint}
            You are in. and here is what we have so far:
            {''.join(self.command_history)}
                   Sincerely
                   {self.net.listened_endpoint()}, The primary.
        """

    def handle_execute_for_primary(self, endpoint: str,
                                   data: str) -> str:
        cmd = data
        self.command_history.append(cmd)
        self.exe.execute(cmd)
        for sub in self.known_subs:
            r = self.net.send(sub,'/pleaseExecuteThis',cmd)
            if not r:
                print(f'Node-{sub} is down,kick it off the group.')
                self.known_subs.remove(sub)

        return f"""
        Dear {endpoint}
             Your request has been carried out by our group.
             Members: {self.known_subs}
                 Sincerely
                 {self.net.listened_endpoint()}, The primary.
        """
\end{simplepy}
ç„¶åæ˜¯å…¶ä»–èŠ‚ç‚¹ç”¨åˆ°çš„æ–¹æ³•:
\begin{simplepy}
    def ask_primary_for_entry(self):
        r = self.net.send(self.primary,
                    '/pleaseAddMe',
                    self.n.listened_endpoint())
        if not r:
            raise Exception('Failed to join the group')
        # In response, the primary should send you the history .
        cmd = r.split('\n')[3]  # forth line is the command
        if cmd:
            self.exe.execute(cmd)
    def start_listening_as_sub(self):
        self.net.listen('/pleaseExecuteThis',
                        self.handle_execute_for_sub)
    def handle_execute_for_sub(self,endpoint: str,data: str) -> str:
        cmd = data
        if (endpoint == self.primary):
            self.exe.execute(cmd)
            return f"""
            Dear boss,
                 Mission accomplished.
                     Sincerely
                     {self.net.listened_endpoint()}
            """
        else:
            # forward
            r = self.net.send(self.primary,
                                 '/pleaseExecuteThis',data)
            if not r:
                raise Exception('failed to forward message to primary')
            return r
\end{simplepy}
æ‰€ä»¥æœ€åæ€»ç»“èµ·æ¥åº”è¯¥å°±æ˜¯ï¼š
\begin{simplepy}
class ListenToOneConsensus:
    def __init__(self,
                 n: IEndpointBasedNetworkable,
                 e: IExecutable,
                 nodeToConnect=''):
        self.net = n
        self.exe = e
        if nodeToConnect:
            self.primary = nodeToConnect
            self.is_primary = false
            self.ask_primary_for_entry()
            self.start_listening_as_sub()
        else:
            self.is_primary = true
            self.start_listening_as_primary()

    def ask_primary_for_entry(self):
        r = self.net.send(self.primary,
                    '/pleaseAddMe',
                    self.n.listened_endpoint())
        if not r:
            raise Exception('Failed to join the group')
        # In response, the primary should send you the history .
        cmd = r.split('\n')[3]  # forth line is the command
        if cmd:
            self.exe.execute(cmd)

    def start_listening_as_primary(self):
        self.known_subs = []
        self.command_history = []
        self.net.listen('/pleaseAddMe',
                        self.handle_add_new_node)
        self.net.listen('/pleaseExecuteThis',
                        self.handle_execute_for_primary)

    def handle_add_new_node(self,sub_endpoint: str,
                            data: str) -> str:
        """[For primary] to add new node"""
        self.known_subs.append(sub_endpoint)
        return f"""
        Dear {sub_endpoint}
            You are in. and here is what we have so far:
            {''.join(self.command_history)}
                   Sincerely
                   {self.net.listened_endpoint()}, The primary.
        """

    def handle_execute_for_primary(self, endpoint: str,
                                   data: str) -> str:
        cmd = data
        self.command_history.append(cmd)
        self.exe.execute(cmd)
        for sub in self.known_subs:
            r = self.net.send(sub,'/pleaseExecuteThis',cmd)
            if not r:
                print(f'Node-{sub} is down,kick it off the group.')
                self.known_subs.remove(sub)

        return f"""
        Dear {endpoint}
             Your request has been carried out by our group.
             Members: {self.known_subs}
                 Sincerely
                 {self.net.listened_endpoint()}, The primary.
        """
    def start_listening_as_sub(self):
        self.net.listen('/pleaseExecuteThis',
                        self.handle_execute_for_sub)
    def handle_execute_for_sub(self,endpoint: str,data: str) -> str:
        cmd = data
        if (endpoint == self.primary):
            self.exe.execute(cmd)
            return f"""
            Dear boss,
                 Mission accomplished.
                     Sincerely
                     {self.net.listened_endpoint()}
            """
        else:
            # forward
            r = self.net.send(self.primary,
                                 '/pleaseExecuteThis',data)
            if not r:
                raise Exception('failed to forward message to primary')
            return r
\end{simplepy}

\section{å¬ä¸€ä¸ªå…±è¯†-ç•™ä¸€æ‰‹ç‰ˆ}

è®©æˆ‘ä»¬ç¨å¾®å†å¤æ‚å¤æ‚ä¸€ç‚¹ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ–°å¢è¿™ä¸¤ä¸ªåŠŸèƒ½ï¼š
\begin{enumerate}
\item åœ¨\cola{primary}æ­»çš„æ—¶å€™å¸Œæœ›å¯ä»¥æœ‰æ¥ç­çš„ã€‚
\item æˆ‘ä»¬å¸Œæœ›æ–°å¢èŠ‚ç‚¹çš„æ—¶å€™å¯ä»¥è¿æ¥åˆ°ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ã€‚
\end{enumerate}
\emoji{parrot} : æ—¢ç„¶\cola{primary}å¯ä»¥ç»™å‘½ä»¤ç¼–å·ï¼Œé‚£ä¹ˆè‡ªç„¶ä¹Ÿå¯ä»¥ç»™æ–°åŠ çš„èŠ‚ç‚¹ç¼–å·
ä¸æ˜¯å—ï¼Ÿ è€Œæˆ‘ä»¬ä¹Ÿå°±å¯ä»¥ç”¨è¿™ä¸ªç¼–å·æ¥å†³å®š\cola{è°æ˜¯ä¸‹ä¸€ä»»primary}ã€‚

æ˜¯çš„é‚£ä¹ˆè¿™æ ·ä»¥æ¥æˆ‘ä»¬çš„é›†ç¾¤å°±å˜æˆäº†ä¸€ä¸ªæœ‰åºå·çš„äº†:
\begin{center}
  \begin{tikzpicture}
    \begin{scope}
      \node[myNode,fill=\mycola,minimum height=4em] (a0) {primary};
      \draw[latex-, very thick] (a0) -- (30:3cm) node[myNode,fill=gray,name=a2]{...};
      \draw[latex-, very thick] (a0) -- (0:3cm) node[myNode,fill=gray,name=a4]{...};

      \draw[latex-, very thick] (a0) -- (300:3cm) node[myNode,fill=\mycolc,name=a1]{1};
      \draw[latex-, very thick] (a1) -- (270:3cm) node[myNode,fill=gray,name=a3]{...};

      \node[text width=6cm,below] at ([shift={(0,-3cm)}]a0.south) {
        \begin{noteBox}
          1.æ–°å¢çš„èŠ‚ç‚¹å¯ä»¥é€šè¿‡\textbf{ä»»æ„ç°
            æœ‰é›†ç¾¤èŠ‚ç‚¹}è¿æ¥ï¼Œä¹‹åä¼šç®¡\cola{primary}è¦ä¸€ä¸ªåºå·ã€‚
        \end{noteBox}
      };
      \node[left,text width=2cm] at ([xshift=-0.5cm]a3.west) {
        \begin{leftDialogBox}
          æ±‚åŠ å…¥
        \end{leftDialogBox}
      };

      \foreach \n in {a2}{
        \node[right,text width=2cm] at ([xshift=0.5cm,yshift=0.5cm]\n.east) {
          \begin{rightDialogBox}
            æ±‚åŠ å…¥
          \end{rightDialogBox}
        };
      }

    \end{scope}


    \begin{scope}[shift={(9.5cm,0)}]
      \node[myNode,fill=\mycola,minimum height=4em] (a0) {primary};
      \draw[latex-, very thick] (a0) -- (30:3cm) node[myNode,fill=\mycolaa,name=a2]{2};
      \draw[latex-, very thick] (a0) -- (0:3cm) node[myNode,fill=\mycolaa,name=a4]{4};

      \draw[latex-, very thick] (a0) -- (300:3cm) node[myNode,fill=\mycolc,name=a1]{1};
      \draw[latex-, very thick] (a1) -- (270:3cm) node[myNode,fill=\mycolaa,name=a3]{3};

      \draw[-latex,very thick] (a4) -- (a1);
      \draw[-latex,very thick] (a2) -- (a1);
      \draw[-latex,very thick] (a3) -- (a0);

      \node[text width=6cm,below] at ([shift={(0,-3cm)}]a0.south) {
        \begin{noteBox}
          2.åœ¨å®Œæˆä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤åï¼Œæ–°å¢çš„èŠ‚ç‚¹å°±ç®—åŠ å…¥é›†ç¾¤äº†ï¼š
          \begin{enumerate}
          \item è®°ä½\cola{primary}å’Œä¸‹ä»»\cola{primary}çš„åœ°å€
          \item è·å¾—è‡ªå·±çš„åºåˆ—å·ã€‚
          \item åŒæ­¥å‘½ä»¤å†å²è®°å½•
          \end{enumerate}
        \end{noteBox}
      };

      \node[left,text width=4cm] at ([xshift=-0.5cm]a0.west) {
        \begin{leftDialogBox}
          \small
          æ¥å§ï¼Œç»™ä½ ä»¬\textbf{è¿‡å¾€æˆ‘ä»¬æ‰§è¡Œçš„è®°å½•}ï¼Œå¦‚æœæˆ‘æ²¡äº†å°±æ‰¾ä¸‹ä¸€ä»»\colc{èŠ‚ç‚¹1}å§ã€‚
        \end{leftDialogBox}
      };
    \end{scope}
      \end{tikzpicture}
\end{center}

\begin{center}
  \begin{tikzpicture}
    \begin{scope}
      \node[myNode,fill=red!40!black,minimum height=4em] (a0) {primary};
      \draw[latex-, very thick] (a0) -- (30:3cm) node[myNode,fill=\mycolaa,name=a2]{2};
      \draw[latex-, very thick] (a0) -- (0:3cm) node[myNode,fill=\mycolaa,name=a4]{4};

      \draw[latex-, very thick] (a0) -- (300:3cm) node[myNode,fill=\mycolc,name=a1]{1};
      \draw[latex-, very thick] (a1) -- (270:3cm) node[myNode,fill=\mycolaa,name=a3]{3};

      \draw[-latex,very thick] (a4) -- (a1);
      \draw[-latex,very thick] (a2) -- (a1);
      \draw[-latex,very thick, red] (a3) -- node[midway] {\emoji{cross-mark}}(a0);

      \node[left,text width=4cm] at ([xshift=-0.5cm]a3.west) {
        \begin{leftDialogBox}
          ï¼Ÿ \cola{primary}è€ä¸å›æˆ‘ï¼Œå®ƒåº”è¯¥æ²¡äº†ï¼Œ\colc{ä½ }ä¸Šå‘—ï¼Ÿ
        \end{leftDialogBox}
      };

      \node[right,text width=4cm] at ([xshift=0.5cm,yshift=0.5cm]a1.east) {
        \begin{rightDialogBox}
          æ˜¯å—ï¼Ÿ è®©æˆ‘ç¡®è®¤ä¸€ä¸‹....å–‚å–‚å–‚ï¼Ÿ \cola{primary}åœ¨å—ï¼Ÿ
        \end{rightDialogBox}
      };

      \node[text width=8cm,below] at ([shift={(0,-4cm)}]a0.south) {
        \begin{noteBox}
          3. å½“æœ‰äººå¾€\cola{primary}å‘æ¶ˆæ¯å¤±è´¥åå°±ä¼šå’Œ\colc{æ¥ç­äºº}è¯´ï¼Œè¯·æ±‚\textbf{view-change}ã€‚
          ç„¶åï¼Œ\colc{æ¥ç­äºº}ä¼šï¼š
          \begin{enumerate}
          \item ç¡®è®¤ä¸€ä¸‹\cola{primary}æ˜¯ä¸æ˜¯çœŸçš„æ²¡äº†
          \item å¦‚æœä¸æ˜¯ï¼Œé‚£è¯´æ˜æ˜¯è¿™ä¸ªå°èŠ‚ç‚¹è‡ªå·±çš„é—®é¢˜
          \end{enumerate}
        \end{noteBox}
      };
    \end{scope}

    \begin{scope}[shift={(6cm,-6cm)}]
      \node[myNode,fill=red!40!black,minimum height=4em] (a0) {dead};
      \draw[latex-, very thick] (a0) -- (30:3cm) node[myNode,fill=\mycolc,name=a2]{2};
      \draw[latex-, very thick] (a0) -- (0:3cm) node[myNode,fill=\mycolaa,name=a4]{4};

      \draw[latex-, very thick,red] (a0) -- node[midway] {\emoji{cross-mark}}
      (300:3cm) node[myNode,fill=\mycola,
      name=a1,minimum height=4em]{primary};
      \draw[latex-, very thick] (a1) -- (270:3cm) node[myNode,fill=\mycolaa,name=a3]{3};

      \draw[-latex,very thick] (a4) -- (a1);
      \draw[-latex,very thick] (a2) -- (a1);
      \draw[-latex,very thick, red] (a3) -- node[midway,sloped] {\emoji{cross-mark}}(a0);

      % \node[left,text width=4cm] at ([xshift=-0.5cm]a3.west) {
      %   \begin{leftDialogBox}
      %     æ¬¸ï¼Ÿ \cola{primary}è€ä¸å›æˆ‘ï¼Œå®ƒåº”è¯¥æ²¡äº†ï¼Œ\colc{ä½ }ä¸Šå‘—ï¼Ÿ
      %   \end{leftDialogBox}
      % };

      \node[right,text width=4cm] at ([xshift=0.5cm,yshift=0.5cm]a1.east) {
        \begin{rightDialogBox}
          è¯¶å‘¦ï¼Œè¿˜çœŸæ²¡äº†...é‚£å¥½å§ã€‚\textbf{å¤§å®¶å¬å¥½äº†}ï¼Œ\cola{primary}è¯¥æ¢æˆ‘
          äº†ï¼Œ\colc{ä¸‹ä¸€ä¸ªæ˜¯èŠ‚ç‚¹\textbf{2}}ï¼Œä½ ä»¬éƒ½è®°ä½å•Šã€‚
        \end{rightDialogBox}
      };

      \node[text width=6cm,below] at ([shift={(0,-3cm)}]a0.south) {
        \begin{noteBox}
          4.å¦‚æœç¡®å®\colc{æ¥ç­äººè‡ªå·±}ä¹Ÿæ²¡æœ‰è¿ä¸Š\cola{ä¸»èŠ‚ç‚¹}ï¼Œåˆ™å¹¿æ’­\textbf{view-change},å¹¶è®©å¤§å®¶äº†
          è§£ä¸‹ä¸€ä»»\colc{æ¥ç­äºº}ã€‚
        \end{noteBox}
      };
    \end{scope}

  \end{tikzpicture}
\end{center}

\begin{myBox}{å¬ä¸€ä¸ªå…±è¯†-ç•™ä¸€æ‰‹ç‰ˆ ï¼ˆFollow-me Consensusï¼‰}
 è§ä¸Šå›¾ 
\end{myBox}

\emoji{parrot} : é‚£å¦‚æœä¸€ä¸ªèŠ‚ç‚¹åŒæ—¶æ”¶åˆ°ä¸¤ä¸ª\cola{primary}çš„æ¶ˆæ¯æ€ä¹ˆåŠå‘¢ï¼Ÿ
é‚£ä¹ˆå°±å’Œå…¶ä»–çš„å…±è¯†ç®—æ³•ä¸€æ ·ï¼ˆRaftï¼ŒPBFTï¼‰ï¼Œ èŠ‚ç‚¹åªéœ€è¦æ¥å—æœ€æ–°çš„å‘½ä»¤å°±è¡Œäº†ã€‚
\end{comment}

\section{é™æ€èŠ‚ç‚¹é›†ç¾¤å…±è¯†}

å¾ˆå¤šæ•™ç§‘ä¹¦é‡Œçš„é›†ç¾¤éƒ½æ˜¯åŸºäº\Cola{é™æ€é›†ç¾¤}çš„ï¼Œä¹Ÿå°±æ˜¯è¯´é›†ç¾¤èŠ‚ç‚¹çš„æ•°é‡ä»å¤´åˆ°å°¾éƒ½ä¸å˜ï¼Œ
è€Œä¸”æ˜¯å·²çŸ¥çš„ã€‚è¿™äº›å…±è¯†åŒ…æ‹¬ï¼šRaftï¼ŒPBFT ç­‰ç­‰ã€‚å®ƒä»¬å¤šå¤šå°‘å°‘éƒ½è¦ä¾èµ–ä¸€ä¸ª``æŠ•ç¥¨''çš„æœºåˆ¶ã€‚

\emoji{parrot} : ç¡®å®ï¼Œä½ å¾—çŸ¥é“æœ‰ä¸€å…±æœ‰å¤šå°‘äººæ‰èƒ½çŸ¥é“\cola{â€œå¤§å¤šæ•°â€}æ˜¯å¤šå°‘äººã€‚

\begin{center}
  \begin{tikzpicture}
    \matrix[column sep=1cm,row sep=1cm,nodes={myNode,fill=gray}]{
      \node[name=a1]{1}; & 
      \node[name=a2]{2}; \\
      \node[name=a3]{3}; & 
      \node[name=a4]{4}; \\
    };

    \foreach \i / \j in {1/2,1/3,1/4,2/3,2/4,3/4}{
      \draw[thick,latex-latex] (a\j) -- (a\i);
    }

  \end{tikzpicture}
\end{center}

é‚£ä¹ˆå¯¹äºè¿™æ ·çš„å…±è¯†ä»–ä»¬çš„ç½‘ç»œåº”è¯¥æ˜¯è¿™æ ·çš„:
\begin{simplepy}
from abc import ABC
class IStaticIdBasedNetworkable(ABC):
    def listen(self,
               target: str,
               handler: Callable[[int,str],Optional[str]]
               ):
        pass
    def my_id(self) -> int:
        pass
    def all_ids(self) -> list[int]:
        pass
    def send(self,i: int, target: str, data: str) -> Optional[str]:
        # i: the target, e.g. 2
        # target: e.g. "/hi"
        pass
    def clear(self):                # clears up all the listeners
        pass
\end{simplepy}
é‚£ä¹ˆæˆ‘ä»¬çœ‹åˆ°å¤§éƒ¨åˆ†å’Œä¹‹å‰\texttt{IEndpointBasedNetworkable}æ˜¯ä¸€æ ·çš„ï¼Œæœ‰æ‰åçš„åŒå­¦
å¯èƒ½æƒ³æŠŠè¿™ä¸¤ä¸ªå†™æˆä¸€ä¸ª\texttt{template<T>}ï¼Œä¸è¿‡è¯·æš‚æ—¶å…ˆåˆ«ã€‚

\section{ä¾‹å­: Raft å…±è¯†å®ç°}
é‚£ä¹ˆåŸºäºä¸Šé¢çš„è¿™ä¸ªæ¥å£ï¼Œæˆ‘ä»¬çš„Raftå…±è¯†åº”è¯¥å°±æ˜¯è¿™æ ·çš„ï¼š
\begin{simplepy}
class RaftConsensus:
    def __init__(self,
                 n: IStaticIdBasedNetworkable,
                 e: IExecutable):
        self.net = n
        self.exe = e
        self.lock_for_patience = Lock()
        self.primary = None
        self.dynasty = 0
        self.voted_dynasty = dict()
        self.lock_for_voted_dynasty = Lock()

        self.start_listening_as_follower()

    def start_listening_as_follower(self):

        self.say('Started as follower')
        self.net.clear()
        self.net.listen('/pleaseAppendEntry', self.handle_append_entry)
        self.net.listen('/pleaseExecute', self.handle_execute)
        self.net.listen('/pleaseVoteMe', self.handle_ask_for_vote)
        self.net.listen('/IamThePrimary', self.handle_primary)

        Thread(target=self.start_internal_clock).start()  # here the ctor ends

    def start_internal_clock(self):
        self.comfort()

        p = -1
        with self.lock_for_patience:
            p = self.patience

        while p > 0:
            sleep(2)
            with self.lock_for_patience:
                self.patience -= 1
                p = self.patience
            self.say(f' patience >> {self.patience}, ğŸ¢PR: {self.primary}')

        self.have_enough()

    def have_enough(self):
        self.say(f' have had enough')
        self.ask_for_votes()

    def handle_append_entry(self, i: int, d: str) -> Optional[str]:
        if i == self.primary:
            self.comfort()
            self.exe.execute(d)     # only primary will append entry
            return f"""
            Dear {i}, the primary
                 I have appended your requested entry. âœ…ï¸ {d}
                        Yours {self.net.my_id()}
            """
        return f"""
        Sorry, {i} âŒï¸
             My primary is {self.primary}, and I will only listen to him/her.
                Regards {self.net.my_id()}
        """

    def comfort(self):          # reset timer
        with self.lock_for_patience:
            self.patience = random.randrange(start=10,stop=20,step=2)
            self.say(f'patience set to = {self.patience}')

    def say(self,s: str):
        print_mt(f'[{self.net.my_id()}]: ' + s)

    def ask_for_votes(self):
        self.dynasty += 1
        with self.lock_for_voted_dynasty:
            self.voted_dynasty[self.dynasty] = self.net.my_id()
        c : int = 1
        for i in [i for i in self.net.all_ids() if i != self.net.my_id()]:
            r: str = self.net.send(i,'/pleaseVoteMe',f"""
            Hi {i}, vote me in the
               {self.dynasty}
                     compaign
                       Yours, {self.net.my_id()}
            """)
            if (r and r.startswith('Yes')):
                c += 1

        if c >= len(self.net.all_ids()) / 2:
            self.start_listening_as_primary(c)
        else:
            self.start_listening_as_follower()

    def start_listening_as_primary(self, c: int):
        self.primary = self.net.my_id()

        self.say(f'Listening as primary')
        for i in [i for i in self.net.all_ids() if i != self.net.my_id()]:
            self.net.send(i,'/IamThePrimary',f"""
            Hi, I got {c} votes to be the new primary,{self.net.my_id()}
                the dynasty number is:
                   {self.dynasty}
                               Regards {self.net.my_id()}
            """)

        self.net.clear()
        self.net.listen('/pleaseExecute',self.handle_execute_for_primary)



        # Make the following a thread
        self.alive = True
        Thread(target=self.heart_beat).start()

    def heart_beat(self):
        while self.alive:
            sleep(6)
            self.say(f'[Primary ğŸ’™]')
            for i in [i for i in self.net.all_ids() if i != self.net.my_id()]:
                self.net.send(i,'/pleaseAppendEntry','Beep')


    def handle_ask_for_vote(self, i: int, d: str) -> Optional[str]:
        self.primary = None
        self.comfort()
        asked_dynasty = int(d.splitlines()[2].strip())
        with self.lock_for_voted_dynasty:
            if asked_dynasty not in self.voted_dynasty:
                self.voted_dynasty[asked_dynasty] = i
                return 'Yes'
        return f"""Sorry,
              I have already voted for this term for
                     {self.voted_dynasty[asked_dynasty]}
                               Regards {self.net.my_id()}
        """

    def handle_primary(self, i: int, d: str) -> Optional[str]:
        self.primary = i
        self.dynasty = int(d.splitlines()[3].strip())
        return f"""
        Dear primary {i},
             from now on I will listen to you in term {self.dynasty}.
                      Regards {self.net.my_id()}
        """

    def handle_execute(self, i: int, d: str) -> Optional[str]:
        if self.primary == None:
            return f"""
            Dear client {i},
                Sorry, our group is electing primary for the moment,
                please try again latter.
                    Regards {self.net.my_id()}
            """
        return self.net.send(self.primary,'/pleaseExecute',d)  # forward

    def handle_execute_for_primary(self, i: int, d: str) -> Optional[str]:
        self.say(f'Primary executing {d}')
        self.exe.execute(d)
        subs = [s for s in self.net.all_ids() if s != self.net.my_id()]
        self.say(f'Asking subs: {subs}')
        for sub in subs:
            self.say(f'Ask {sub} to execute {d}')
            self.net.send(sub,'/pleaseAppendEntry',d)
            # Thread(target=
            #        lambda : 
            #        ).start()
        return f"""
        Dear client,
             Your requests {d} have been executed by our group
                  Regards {self.net.my_id()}, the primary
        """
\end{simplepy}
ç„¶å,å¦‚æœæƒ³è¦æŠŠé›†ç¾¤è·‘èµ·æ¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå‡çš„ç½‘ç»œå’Œæ‰§è¡Œå™¨ï¼š
\begin{simplepy}
class MockedExecutable(IExecutable):
    def __init__(self, i: int):
        self.id = i
    def execute(self,command: str):
        print_mt(f'ğŸ¦œ {S.RED} [{self.id}] Exec: {command} {S.NOR}')


class MockedIdNetworkNode(IStaticIdBasedNetworkable):
    def __init__(self,i:int):
        self.id = i
    def my_id(self) -> int:
        return self.id
    def all_ids(self) -> list[int]:
        return network_nodes
    def send(self,i: int, target: str, data: str) -> Optional[str]:
        k = f'{i}-{target}'
        print_mt(f'{S.CYAN} Calling handler: {k} {S.NOR} with data:\n {S.CYAN} {data} {S.NOR}')
        if k in network_hub:
            r = network_hub[k](self.id,data)
        else:
            print_mt(f'Handler {k} not found')
            r = None
        print_mt(f'Got result:{S.GREEN} {r} {S.NOR}')
        return r

    def clear(self):                # clears up all the listeners
        with lock_for_netwok_hub:
            for k in list(network_hub.keys()):
                if k.startswith(f'{self.id}-'):
                    print_mt(f'Removing handler: {k}')
                    network_hub.pop(k)

    def listen(self,
               target: str,
               handler: Callable[[int,str],Optional[str]]
               ):
        k = f'{self.id}-{target}'
        print_mt(f'Adding handler: {k}')
        network_hub[k] = handler

\end{simplepy}
\begin{tcolorbox}
  \emoji{parrot} è¿™é‡Œæˆ‘ä»¬è¿˜ç”¨äº†ä¸€äº›å¸®æ‰‹å‡½æ•°ï¼šè¿™äº›å‡½æ•°æ²¡å•¥é‡è¦çš„ï¼Œå°±æ˜¯ç”¨æ¥æ–¹ä¾¿æ‰“å°
  æ—¥å¿—çš„ã€‚
  \begin{simplepy}
import threading
from threading import Thread, Timer, Lock
import random
# from random import randrange
from time import sleep

lock_for_print = Lock()
def print_mt(*args,**kwargs):
    with lock_for_print:
        print(*args,**kwargs)

class S:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    MAG = '\033[93m'
    RED = '\033[91m'
    NOR = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
  \end{simplepy}
\end{tcolorbox}
è€Œä½¿ç”¨çš„è¯å°±æ˜¯è¿™ä¹ˆç”¨ï¼š
\begin{simplepy}
network_hub : dict[str, Callable[[int,str],Optional[str]]] = dict()
lock_for_netwok_hub = Lock()
network_nodes = list(range(3))

network_iface = [MockedIdNetworkNode(i) for i in network_nodes]
executor_iface = [MockedExecutable(i) for i in network_nodes]
consensus_nodes = [
    RaftConsensus(network_iface[i],executor_iface[i]) for i in network_nodes
]

nClient = MockedIdNetworkNode(1234)
while True:
    # reply = input('Enter cmd: <id> <cmd>')
    reply = input('Enter: ')
    if reply == 'stop': break

    l = reply.split(' ')

    # Simulate a dead node
    if l[0] == 'down':
        i = int(l[1])
        print_mt(f'{S.HEADER} Turning down node-{i} {S.NOR}')
        consensus_nodes[i].net.clear()
        consensus_nodes[i].alive = False
    else:
        # Execute a command
        i = int(l[0])
        print_mt(f'{S.HEADER} Sending {l[1]} to node-{i} {S.NOR}')
        nClient.send(i,'/pleaseExecute',l[1])
  
\end{simplepy}

ç„¶ååœ¨å‘½ä»¤è¡Œé‡Œæˆ‘ä»¬å°±å¯ä»¥éƒ¨ç½²é›†ç¾¤å¹¶å‘é€æ¶ˆæ¯äº†ã€‚ å¦‚æœæƒ³è¦å¾€é›†ç¾¤å‘é€å‘½ä»¤ä½¿ç”¨ï¼š
\begin{center}
  \cola{\texttt{<èŠ‚ç‚¹id>}} \colb{\texttt{<å‘½ä»¤>}}
\end{center}
æ¯”å¦‚ï¼š
\begin{center}
  \cola{\texttt{1}} \colb{\texttt{aaa}} ï¼ˆå¾€1å‘é€\texttt{aaa}ï¼‰ \\
  \cola{\texttt{2}} \colb{\texttt{bbb}} ï¼ˆå¾€2å‘é€\texttt{bbb}ï¼‰\\
\end{center}

è€Œå¦‚æœæƒ³è¦æ¨¡æ‹Ÿä¸€ä¸ªèŠ‚ç‚¹downäº†ï¼Œé‚£å°±ç”¨ï¼š
\begin{center}
  \cola{\texttt{down}} \colb{\texttt{<èŠ‚ç‚¹id>}}
\end{center}

 \begin{tcolorbox}[breakable,title=Raftå…±è¯†æ¨¡æ‹Ÿçš„å‘½ä»¤è¡Œè¾“å‡ºï¼ˆéƒ¨åˆ†æ²¡å•¥ç”¨çš„è¾“å‡ºè¢«çœç•¥äº†ï¼‰]
  \begin{verbatim}
ä»è¿™é‡Œå¼€å§‹ --------------------------------------------------
[0]: Started as follower
Adding handler: 0-/pleaseAppendEntry
Adding handler: 0-/pleaseExecute
Adding handler: 0-/pleaseVoteMe
Adding handler: 0-/IamThePrimary
[0]: patience set to = 18
[1]: Started as follower
Adding handler: 1-/pleaseAppendEntry
Adding handler: 1-/pleaseExecute
Adding handler: 1-/pleaseVoteMe
Adding handler: 1-/IamThePrimary
[1]: patience set to = 18
[2]: Started as follower
Adding handler: 2-/pleaseAppendEntry
Adding handler: 2-/pleaseExecute
Adding handler: 2-/pleaseVoteMe
Adding handler: 2-/IamThePrimary
[2]: patience set to = 16
Enter: [0]:  patience >> 17, ğŸ¢PR: None
[1]:  patience >> 17, ğŸ¢PR: None
... ç•¥ ... 
[2]:  patience >> 0, ğŸ¢PR: None
[2]:  have had enough
 Calling handler: 0-/pleaseVoteMe  with data:
  
            Hi 0, vote me in the
               1
                     compaign
                       Yours, 2
             
[0]: patience set to = 10
Got result: Yes 
 Calling handler: 1-/pleaseVoteMe  with data:
  
            Hi 1, vote me in the
               1
                     compaign
                       Yours, 2
             
[1]: patience set to = 14
Got result: Yes 
[2]: Listening as primary
 Calling handler: 0-/IamThePrimary  with data:
  
            Hi, I got 3 votes to be the new primary,2
                the dynasty number is:
                   1
                               Regards 2
             
Got result: 
        Dear primary 2,
             from now on I will listen to you in term 1.
                      Regards 0
         
 Calling handler: 1-/IamThePrimary  with data:
  
            Hi, I got 3 votes to be the new primary,2
                the dynasty number is:
                   1
                               Regards 2
             
Got result: 
        Dear primary 2,
             from now on I will listen to you in term 1.
                      Regards 1
         
Removing handler: 2-/pleaseAppendEntry
Removing handler: 2-/pleaseExecute
Removing handler: 2-/pleaseVoteMe
Removing handler: 2-/IamThePrimary
Adding handler: 2-/pleaseExecute
ä»è¿™é‡Œå¼€å§‹ 2 å°±æ˜¯ primary--------------------------------------------------
[0]:  patience >> 9, ğŸ¢PR: 2
[1]:  patience >> 13, ğŸ¢PR: 2
[0]:  patience >> 8, ğŸ¢PR: 2
[1]:  patience >> 12, ğŸ¢PR: 2
[0]:  patience >> 7, ğŸ¢PR: 2
[1]:  patience >> 11, ğŸ¢PR: 2
[2]: [Primary ğŸ’™]
 Calling handler: 0-/pleaseAppendEntry  with data:
  Beep 
[0]: patience set to = 18
ğŸ¦œ  [0] Exec: Beep 
..... ç•¥
è¿™é‡Œå¾€èŠ‚ç‚¹ 1 å‘é€å‘½ä»¤ ï¼ˆaï¼‰--------------------------------------------------
 Sending a to node-1 
 Calling handler: 1-/pleaseExecute  with data:
  a 
 Calling handler: 2-/pleaseExecute  with data:
  a 
[2]: Primary executing a
ğŸ¦œ  [2] Exec: a  ï¼ˆè¿™é‡Œprimaryæ‰§è¡Œäº†) --------------------------------------------------
[2]: Asking subs: [0, 1]
[2]: Ask 0 to execute a
 Calling handler: 0-/pleaseAppendEntry  with data:
  a 
[0]: patience set to = 16
ğŸ¦œ  [0] Exec: a  (0 æ‰§è¡Œäº†) --------------------------------------------------
Got result: 
            Dear 2, the primary
                 I have appended your requested entry. âœ…ï¸ a
                        Yours 0
             
[2]: Ask 1 to execute a
 Calling handler: 1-/pleaseAppendEntry  with data:
  a 
[1]: patience set to = 18
ğŸ¦œ  [1] Exec: a  (1 ä¹Ÿæ‰§è¡Œäº†)
Got result: 
            Dear 2, the primary
                 I have appended your requested entry. âœ…ï¸ a
                        Yours 1
             
Got result: 
        Dear client,
             Your requests a have been executed by our group
                  Regards 2, the primary
         
... ç•¥...
down 2
(è¿™é‡Œå…³æ‰èŠ‚ç‚¹2 ï¼ˆprimaryï¼‰å¿ƒè·³ä¸å†å‘é€) ------------------------------------------
 Turning down node-2 
Removing handler: 2-/pleaseExecute
Enter: [2]: [Primary ğŸ’™]
[1]:  patience >> 10, ğŸ¢PR: 2
 Calling handler: 0-/pleaseAppendEntry  with data:
  Beep 
[0]: patience set to = 14
ğŸ¦œ  [0] Exec: Beep 
Got result: 
            Dear 2, the primary
                 I have appended your requested entry. âœ…ï¸ Beep
                        Yours 0
             
 Calling handler: 1-/pleaseAppendEntry  with data:
  Beep 
[1]: patience set to = 16
ğŸ¦œ  [1] Exec: Beep 
Got result: 
            Dear 2, the primary
                 I have appended your requested entry. âœ…ï¸ Beep
                        Yours 1
ï¼ˆè¿˜åœ¨ç­‰å¿ƒè·³çš„å…¶ä»–èŠ‚ç‚¹ï¼‰ --------------------------------------------------
[0]:  patience >> 13, ğŸ¢PR: 2
... ç•¥ ...
[0]:  patience >> 1, ğŸ¢PR: 2
[1]:  patience >> 3, ğŸ¢PR: 2
[0]:  patience >> 0, ğŸ¢PR: 2
[0]:  have had enough
(æ²¡æœ‰ç­‰åˆ°å¿ƒè·³ï¼ŒèŠ‚ç‚¹0å‘èµ·æŠ•ç¥¨)----------------------------------------------
 Calling handler: 1-/pleaseVoteMe  with data:
  
            Hi 1, vote me in the
               2
                     compaign
                       Yours, 0
             
[1]: patience set to = 10
Got result: Yes 
 Calling handler: 2-/pleaseVoteMe  with data:
  
            Hi 2, vote me in the
               2
                     compaign
                       Yours, 0
             
Handler 2-/pleaseVoteMe not found
Got result: None 
--------------------------------------------------
(èŠ‚ç‚¹0 æˆä¸ºæ–°çš„primary)
[0]: Listening as primary
 Calling handler: 1-/IamThePrimary  with data:
  
            Hi, I got 2 votes to be the new primary,0
                the dynasty number is:
                   2
                               Regards 0
             
Got result: 
        Dear primary 0,
             from now on I will listen to you in term 2.
                      Regards 1
         
 Calling handler: 2-/IamThePrimary  with data:
  
            Hi, I got 2 votes to be the new primary,0
                the dynasty number is:
                   2
                               Regards 0
             
Handler 2-/IamThePrimary not found
Got result: None 
Removing handler: 0-/pleaseAppendEntry
Removing handler: 0-/pleaseExecute
Removing handler: 0-/pleaseVoteMe
Removing handler: 0-/IamThePrimary
Adding handler: 0-/pleaseExecute
[1]:  patience >> 9, ğŸ¢PR: 0
[1]:  patience >> 8, ğŸ¢PR: 0
[1]:  patience >> 7, ğŸ¢PR: 0
èŠ‚ç‚¹ 0 å‘é€å¿ƒè·³ --------------------------------------------------
[0]: [Primary ğŸ’™] 
 Calling handler: 1-/pleaseAppendEntry  with data:
  Beep 
[1]: patience set to = 10
ğŸ¦œ  [1] Exec: Beep 
Got result: 
            Dear 0, the primary
                 I have appended your requested entry. âœ…ï¸ Beep
                        Yours 1
             
 Calling handler: 2-/pleaseAppendEntry  with data:
  Beep 
Handler 2-/pleaseAppendEntry not found
Got result: None 
[1]:  patience >> 9, ğŸ¢PR: 0
[1]:  patience >> 8, ğŸ¢PR: 0
[0]: [Primary ğŸ’™]
..ç•¥...
\end{verbatim}
\end{tcolorbox}

\end{document}


% Local Variables:
% TeX-engine: luatex
% TeX-command-extra-options: "-shell-escape"
% End: